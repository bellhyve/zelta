.\" Automatically generated by Pandoc 3.8.3
.\"
.TH "zelta\-backup" "8" "" "" "System Manager\(cqs Manual"
.SH NAME
\f[B]zelta backup\f[R] \- replicate a ZFS dataset tree
.SH SYNOPSIS
\f[B]zelta backup\f[R] [\f[I]OPTIONS\f[R]] \f[I]source\f[R]
\f[I]target\f[R]
.SH DESCRIPTION
\f[B]zelta backup\f[R] recursively replicates snapshots from a
\f[I]source\f[R] ZFS dataset to a \f[I]target\f[R] dataset.
Both \f[I]source\f[R] and \f[I]target\f[R] may be local or remote via
\f[B]ssh(1)\f[R].
.PP
As with other Zelta commands, \f[B]zelta backup\f[R] works recursively
on a dataset tree.
The \f[I]target\f[R] dataset must be a replica of the \f[I]source\f[R]
or must not exist.
.PP
Prior to replication, \f[B]zelta backup\f[R] analyzes both source and
target to automatically select optimal \f[CR]zfs send\f[R] and
\f[CR]zfs recv\f[R] options.
This process includes property inspection, parent dataset creation if
needed, snapshot GUID comparison via \f[B]zelta match\f[R], and one or
more send/recv operations to update the target.
.SS Replication Process
\f[B]zelta backup\f[R] performs these operations:
.IP "1." 3
\f[B]Property Analysis\f[R]: Source and target properties are checked
using \f[CR]zfs get\f[R] to detect encryption, written state, and other
features.
.IP "2." 3
\f[B]Parent Creation\f[R]: If the target dataset\(cqs parent does not
exist, it will be created with \f[CR]zfs create\f[R].
.IP "3." 3
\f[B]Snapshot Comparison\f[R]: Using \f[B]zelta match\f[R], a snapshot
GUID comparison is performed with \f[CR]zfs list\f[R] to identify
matching snapshots and determine the optimal replication strategy.
.IP "4." 3
\f[B]Snapshot Creation\f[R]: If the source has uncommitted changes and
no recent snapshot exists, a new snapshot is created (unless
\f[CR]\-\-no\-snapshot\f[R] is specified).
.IP "5." 3
\f[B]Incremental Sync\f[R]: One or more \f[CR]zfs send/zfs recv\f[R]
operations are performed to update the target, using incremental sends
when possible.
.SS Send Options
The following \f[CR]zfs send\f[R] options are applied based on dataset
properties:
.IP \(bu 2
\f[B]Default\f[R]: \f[CR]\-\-large\-block\f[R],
\f[CR]\-\-compressed\f[R], \f[CR]\-\-embed\f[R]
.IP \(bu 2
\f[B]Encrypted Datasets\f[R]: \f[CR]\-\-large\-block\f[R],
\f[CR]\-\-raw\f[R]
.IP \(bu 2
\f[B]New/Full Syncs\f[R]: Also includes \f[CR]\-\-props\f[R]
.IP \(bu 2
\f[B]Replicate Mode\f[R] (\f[CR]\-R\f[R]): \f[CR]\-\-replicate\f[R],
\f[CR]\-\-large\-block\f[R], \f[CR]\-\-raw\f[R],
\f[CR]\-\-skip\-missing\f[R]
.SS Target Safety Features
To ensure safe and repeatable replication, the following measures are
applied to the target:
.IP \(bu 2
The property \f[CR]readonly=on\f[R] is set on the topmost dataset
requested
.IP \(bu 2
Synced filesystems are not mounted on the \f[I]target\f[R] during
replication
.IP \(bu 2
On newly backed up filesystems, property \f[CR]canmount=noauto\f[R] is
set
.IP \(bu 2
On newly backed up filesystems, mountpoints are inherited to prevent
overlapping mounts
.SS Source and Target Endpoints
Remote dataset endpoint names follow \f[B]scp(1)\f[R] conventions and
require standard ZFS utilities and SSH access.
Note that Zelta does \f[B]not\f[R] need to be installed on remote ZFS
servers.
.PP
Examples:
.IP
.EX
Local:  pool/dataset
Local:  pool/dataset\(atsnapshot
Remote: user\(atexample.com:pool/dataset
Remote: user\(atexample.com:pool/dataset\(atsnapshot
.EE
.SH OPTIONS
.SS Endpoint Arguments (Required)
If both endpoints are remote, the default behavior is \f[B]pull
replication\f[R] (\f[CR]\-\-pull\f[R]).
This requires that the \f[I]target\f[R] user have ssh access to the
\f[I]source\f[R], typically provided by ssh keys or agent forwarding.
For advanced ssh configuration, see \f[I]https://zelta.space\f[R].
.TP
\f[I]source\f[R]
The dataset to replicate.
If a snapshot is specified, replication will sync up to that snapshot.
.TP
\f[I]target\f[R]
The dataset which will be updated.
.PP
\f[B]Output Options\f[R]
.TP
\f[B]\-v, \-\-verbose\f[R]
Increase verbosity.
Specify once for operational detail, twice (\f[CR]\-vv\f[R]) for debug
output.
.TP
\f[B]\-q, \-\-quiet\f[R]
Quiet output.
Specify once to suppress warnings, twice (\f[CR]\-qq\f[R]) to suppress
errors.
.TP
\f[B]\-j, \-\-json\f[R]
Output results in JSON format.
See \f[B]zelta\-options(8)\f[R] for details.
.TP
\f[B]\-n, \-\-dryrun, \-\-dry\-run\f[R]
Display \f[CR]zfs\f[R] commands without executing them.
.SS Connection Options
.TP
\f[B]\-\-push, \-\-pull, \-\-sync\-direction\f[R] \f[I]DIRECTION\f[R]
When both endpoints are remote, use \f[CR]PULL\f[R] (default) or
\f[CR]PUSH\f[R] sync direction.
.TP
\f[B]\-\-recv\-pipe\f[R] \f[I]COMMAND\f[R]
Pipe \f[CR]zfs receive\f[R] output through the indicated command, such
as \f[CR]dd status=progress\f[R].
.SS Dataset Options
.TP
\f[B]\-d, \-\-depth\f[R] \f[I]LEVELS\f[R]
Limit recursion depth.
For example, a depth of 1 includes only the specified dataset.
.TP
\f[B]\-\-exclude, \-X\f[R] \f[I]PATTERN\f[R]
Exclude /dataset/suffix, \(atsnapshot, or #bookmark beginning with the
indicated symbol.
Wildcards \f[CR]?\f[R] and \f[CR]*\f[R] are permitted.
See \f[B]zelta\-match(8)\f[R].
.SS Snapshot Options
.TP
\f[B]\-\-no\-snapshot\f[R]
Do not create snapshots.
If a snapshot is needed for replication, the operation will fail.
.TP
\f[B]\-\-snapshot, \-\-snapshot\-always\f[R]
Force snapshot creation even if the source has no uncommitted changes.
.TP
\f[B]\-\-snap\-name\f[R] \f[I]NAME\f[R]
Specify snapshot name.
Use \f[CR]$(command)\f[R] for dynamic generation.
Default: \f[CR]$(date \-u +zelta_%Y\-%m\-%d_%H.%M.%S)\f[R].
.TP
\f[B]\-\-snap\-mode\f[R] \f[I]MODE\f[R]
Specify when to snapshot: \f[CR]NEVER\f[R] (or \f[CR]0\f[R]),
\f[CR]IF_NEEDED\f[R] (default, only if source has new data or no recent
snapshot), or \f[CR]ALWAYS\f[R].
.SS Sync Options
.TP
\f[B]\-R, \-\-replicate\f[R]
Use \f[CR]zfs send \-\-replicate\f[R] instead of Zelta\(cqs
per\-snapshot analysis.
This sends all snapshots, bookmarks, and properties in a single process
but provides less granular control over send options.
.TP
\f[B]\-I\f[R]
Sync all intermediate source snapshots using \f[CR]zfs send \-I\f[R] for
updates.
This is the default behavior.
See \f[B]\-i\f[R].
.TP
\f[B]\-i, \-\-incremental\f[R]
Sync only the latest snapshot, skipping any intermediate snapshots.
For full backups only the latest snapshot will be sent.
For incremental backups, \f[CR]zfs send \-i\f[R] will be used.
.TP
\f[B]\-\-resume, \-\-no\-resume\f[R]
Enable (default) or disable automatic resume of interrupted syncs.
.SS Advanced Override Options
\f[B]WARNING:\f[R] These options override Zelta\(cqs automatic safety
and efficiency logic.
Incorrect usage can result in target data loss or decrypted backup
streams.
Use only when you understand the implications.
.PP
Zelta automatically applies non\-destructive and efficient
\f[CR]zfs send\f[R] and \f[CR]zfs recv\f[R] options based on dataset
type and context.
These defaults can be modified three ways:
.IP "1." 3
\f[B]Granular Override Options\f[R] \(em Override specific contexts
(encrypted vs unencrypted, filesystem vs volume, etc.)
.IP "2." 3
\f[B]Dataset Tree Override Options\f[R] \(em Replace all
\f[CR]zfs send\f[R] or \f[CR]zfs recv\f[R] options for an entire backup
job
.IP "3." 3
\f[B]Pass\-Through Override Flags\f[R] \(em Directly pass unambiguous
\f[CR]zfs send\f[R] or \f[CR]zfs recv\f[R] flags
.PP
\f[B]Most Common Use Case: Recompress Backups\f[R]
.PP
Typically, users adjust Zelta options because they would like to
aggressively compress data on their backup endpoints.
This is best done with the \f[CR]\-\-send\-default\f[R] and
\f[CR]\-\-recv\-default\f[R] flags, which will not prevent Zelta from
sending encrypted backups in raw (encrypted) format:
.IP
.EX
zelta backup \-\-send\-default \-Le \-\-recv\-default \(aq\-o compression=zstd\-5\(aq source backup
.EE
.PP
All overrides can also be configured globally in \f[CR]zelta.env\f[R] or
per\-job via \f[CR]zelta.conf\f[R].
.SS Important: Options with Special Handling
Several \f[CR]zfs send\f[R] and \f[CR]zfs recv\f[R] options have special
meaning in Zelta and should generally \f[B]not\f[R] be included in
override strings:
.PP
\f[B]Zelta uses these internally:\f[R] \-
\f[CR]zfs send \-\-parsable (\-P)\f[R] \(em Used for progress tracking
\- \f[CR]zfs recv \-v\f[R] \(em Used for operational feedback
.PP
\f[B]These have Zelta\-specific behavior (see OPTIONS above):\f[R] \-
\f[CR]\-I\f[R] and \f[CR]\-i\f[R] \(em Control incremental behavior; use
the flags documented above instead \- \f[CR]\-\-exclude, \-X\f[R] \(em
Has additional Zelta functionality beyond the \f[CR]zfs send\f[R]
version \- \f[CR]\-\-dryrun, \-n\f[R] \(em Shows commands that would
run; handled by Zelta \- \f[CR]\-t\f[R] \(em Used automatically for
resume tokens
.PP
\f[B]Not supported:\f[R] \- \f[CR]zfs send \-S\f[R] \(em Unsupported \-
\f[CR]zfs recv \-A\f[R] \(em Should be used manually when needed
.SS Granular Override Options
For precise control in a dataset tree with mixed types, override
specific contexts.
These options are \f[B]cumulative\f[R]\(emfor example, a filesystem
receive will combine options from \f[CR]\-\-recv\-default\f[R],
\f[CR]\-\-recv\-top\f[R] (if applicable), and \f[CR]\-\-recv\-fs\f[R].
.TP
\f[B]\(ensend\-default\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
\f[CR]zfs send\f[R] options for \f[B]unencrypted\f[R] datasets (default:
\f[CR]\-Lce\f[R])
.TP
\f[B]\(ensend\-raw\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
\f[CR]zfs send\f[R] options for \f[B]encrypted\f[R] datasets (default:
\f[CR]\-Lw\f[R])
.TP
\f[B]\(ensend\-new\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Additional \f[CR]zfs send\f[R] options during full (non\-incremental)
backups (default: \f[CR]\-p\f[R])
.TP
\f[B]\(enrecv\-default\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
\f[CR]zfs recv\f[R] options for all datasets (none by default)
.TP
\f[B]\(enrecv\-top\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Additional \f[CR]zfs recv\f[R] options for the topmost dataset only
(default: \f[CR]\-o readonly=on\f[R])
.TP
\f[B]\(enrecv\-fs\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Additional \f[CR]zfs recv\f[R] options for filesystem datasets (default:
\f[CR]\-u \-o canmount=noauto \-x mountpoint\f[R])
.TP
\f[B]\(enrecv\-vol\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Additional \f[CR]zfs recv\f[R] options for volume datasets (default:
\f[CR]\-o volmode=none\f[R])
.PP
\f[B]Examples:\f[R]
.IP
.EX
# Allow target to recompress unencrypted data
zelta backup \-\-send\-default \(dq\-Le\(dq source target

# Change volume mode on target
zelta backup \-\-recv\-vol \(dq\-o volmode=dev\(dq source target

# Avoid mountpoint permission issues on some systems
zelta backup \-\-recv\-fs \(dq\-o mountpoint=none\(dq source target
.EE
.SS Dataset Tree Override Options
These options \f[B]replace all context\-specific defaults\f[R] for an
entire backup job.
Use when you need complete control over a specific command.
.TP
\f[B]\(ensend\-override\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Override all default \f[CR]zfs send\f[R] options
.TP
\f[B]\(enrecv\-override\f[R] \f[I]\(lqOPTIONS\(rq\f[R]
Override all default \f[CR]zfs recv\f[R] options
.PP
\f[B]Example:\f[R]
.IP
.EX
# Use minimal \(gazfs send\(ga to send uncompressed (**and decrypted!**) streams and recompress aggressively on the target
zelta backup \-\-send\-override \(dq\-L\(dq \-\-recv\-override \(dq\-o compression=zstd\-5\(dq source target
.EE
.SS Pass\-Through Override Flags
If \f[B]any\f[R] pass\-through flag is specified, it replaces
\f[B]all\f[R] automatic options for that command.
For example, specifying \f[CR]\-L\f[R] alone means \f[CR]zfs send\f[R]
will receive \f[B]only\f[R] \f[CR]\-L\f[R]\(emno compression, no
embedded data, no properties.
.PP
The following unambiguous \f[CR]zfs send\f[R] and \f[CR]zfs recv\f[R]
flags are passed through directly:
.PP
\f[B]zfs send:\f[R]
\f[CR]\-b, \-\-backup, \-\-embed, \-\-holds, \-L, \-\-largeblock, \-\-proctitle, \-\-props, \-\-raw, \-\-skipmissing, \-V, \-w\f[R]
.PP
\f[B]zfs recv:\f[R] \f[CR]\-F, \-M, \-u\f[R]
.PP
\f[B]Ambiguous or unsupported flags:\f[R] \- Single\-dash options with
multiple meanings are \f[B]not supported\f[R]:
\f[CR]\-c, \-d, \-e, \-h, \-s\f[R] \- Options with Zelta\-specific
handlers (see above): \f[CR]\-I, \-i, \-R, \-X, \-n\f[R]
.PP
\f[B]Example:\f[R]
.IP
.EX
# Recompress at target with zstd\-5
# WARNING: This disables encrypted sends!
zelta backup \-L \-\-recv\-override \(dq\-o compression=zstd\-5\(dq source target
.EE
.PP
\f[B]When in doubt, use the granular override options instead.\f[R]
.SH EXAMPLES
The same command works for both new and existing target datasets.
.PP
Local replication with automatic snapshot creation:
.IP
.EX
zelta backup sink/source/dataset tank/target/dataset
.EE
.PP
Remote to local synchronization:
.IP
.EX
zelta backup remote_host:sink/source/dataset tank/target/dataset
.EE
.PP
Dry run to preview commands:
.IP
.EX
zelta backup \-n sink/source/dataset tank/target/dataset
.EE
.PP
Replicate with custom snapshot naming:
.IP
.EX
zelta backup \(rs\-\-snap\-name \(dqbackup_$(date +%Y%m%d)\(dq \(rs
    sink/source/dataset tank/backups/source/dataset
.EE
.PP
Incremental sync, skipping intermediate snapshots:
.IP
.EX
zelta backup \-i sink/source tank/target
.EE
.PP
Limit recursion depth:
.IP
.EX
zelta backup \-d 2 sink/source tank/target
.EE
.SH EXIT STATUS
Returns 0 on success, non\-zero on error.
.SH NOTES
See \f[B]zelta\-options(8)\f[R] for environment variables,
\f[CR]zelta.env\f[R] configuration, and \f[CR]zelta policy\f[R]
integration.
.PP
The \f[CR]zelta sync\f[R] command is a convenience alias for
\f[CR]zelta backup \-i\f[R] and may be extended in future versions with
additional optimizations for continuous replication workflows.
.SH SEE ALSO
zelta(8), zelta\-options(7), zelta\-match(8), zelta\-policy(8),
zelta\-clone(8), zelta\-revert(8), zelta\-rotate(8), ssh(1), zfs(8),
zfs\-send(8), zfs\-receive(8)
.SH AUTHORS
Daniel J. Bell <\f[I]bellhyve\(atzelta.space\f[R]>
.SH WWW
https://zelta.space
