'\" t
.\" Automatically generated by Pandoc 3.8.3
.\"
.TH "zelta\-options" "7" "" "" "System Manager\(cqs Manual"
.SH NAME
\f[B]zelta\-options\f[R] \- environment and policy options for Zelta
behavior
.SH SYNOPSIS
Environment variables and policy configuration options.
.SH DESCRIPTION
Zelta\(cqs behavior can be modified through environment variables,
command\-line arguments, and policy configuration files.
This manual documents all available options and their effects.
.PP
Options are set differently based on context:
.IP \(bu 2
\f[B]Shell environment\f[R]: Environment variables must be prefixed with
\f[CR]ZELTA_\f[R] (e.g., \f[CR]ZELTA_DEPTH=2\f[R])
.IP \(bu 2
\f[B]Environment file\f[R]: In \f[CR]zelta.env\f[R], use
\f[CR]KEY=value\f[R] pairs (e.g., \f[CR]DEPTH=2\f[R])
.IP \(bu 2
\f[B]Policy file\f[R]: \f[CR]zelta policy\f[R] additionally uses the
YAML\-like \f[CR]zelta.conf\f[R] for granular settings per backup job
with \f[CR]KEY: value\f[R] pairs (e.g., \f[CR]DEPTH: 1\f[R])
.IP \(bu 2
\f[B]Command\-line arguments\f[R]: Options map to double\-dash arguments
(e.g., \f[CR]\-\-depth\f[R])
.PP
For on/off variable assignments, use \(lq1\(rq for true and \(lq0\(rq
for false.
.SS Option Hierarchy
Options follow an override hierarchy to provide flexibility in all
contexts.
.IP "1." 3
\f[B]Defaults\f[R] \- Built\-in defaults in the \f[CR]zelta\f[R]
controller script
.IP "2." 3
\f[B]\f[CB]zelta.env\f[B]\f[R] \- System\-wide environment file
(default: \f[CR]/usr/local/etc/zelta/zelta.env\f[R])
.IP "3." 3
\f[B]\f[CB]zelta.conf\f[B]\f[R] \- Policy configuration file
(\f[CR]zelta policy\f[R] only, default:
\f[CR]/usr/local/etc/zelta/zelta.conf\f[R])
.IP "4." 3
\f[B]Environment variables\f[R] \- User environment (must prefix names
with \f[CR]ZELTA_\f[R])
.IP "5." 3
\f[B]Command\-line arguments\f[R] \- Highest priority, overrides all
other sources
.PP
For example, running \f[CR]zelta policy \-\-no\-snapshot\f[R] will
ensure the all configured backups will run without taking snapshots
regardless of snapshot configuration in other contexts.
.SH SETUP AND ENVIRONMENT\-ONLY OPTIONS
The following options should be modified in the environment to ensure
proper installation and startup of the \f[CR]zelta\f[R] script.
Typically, these should be defined in the user\(cqs shell rc script.
In particular, \f[CR]ZELTA_AWK\f[R] and \f[CR]ZELTA_ENV\f[R] will be
used prior to loading \f[CR]zelta.env\f[R] so they must be exported
beforehand.
.TP
\f[B]ZELTA_AWK\f[R]
The \f[B]awk\f[R] executable.
The default is the awk in the path.
Example: \f[CR]ZELTA_AWK=\(aqmawk \-Wi\(aq\f[R].
.TP
\f[B]ZELTA_SHARE\f[R]
The location of Zelta assets including the AWK scripts and data files.
The default is \f[CR]/usr/local/share/zelta\f[R].
.TP
\f[B]ZELTA_ETC\f[R]
The location of \f[CR]zelta.env\f[R] and \f[CR]zelta.conf\f[R].
The default is \f[CR]/usr/local/etc/zelta\f[R].
.TP
\f[B]ZELTA_ENV\f[R]
The exact path of \f[CR]zelta.env\f[R].
.TP
\f[B]ZELTA_DOC\f[R]
The location of Zelta\(cqs manpages.
Default is unset, using the system\-wide manual.
.SH LOGGING OPTIONS
.TP
\f[B]LOG_FILE\f[R]
Divert all output into the indicated file.
.TP
\f[B]LOG_LEVEL\f[R]
Specify a log level value 0\-4: errors (0), warnings (1), notices (2,
default), info (3, verbose), and debug (4).
.TP
\f[B]LOG_MODE\f[R]
Enable the specified log modes.
Currently supported: `text' (default) and `json'
(\f[CR]zelta backup\f[R] related verbs only).
.SH SSH OPTIONS
.TP
\f[B]REMOTE_COMMAND\f[R]
The remote shell command.
Defaults to \f[CR]ssh\f[R].
.TP
\f[B]REMOTE_DEFAULT\f[R]
The default remote shell command used for misc operations which should
prevent reading from stdin.
Defaults to \f[CR]REMOTE_COMMAND \-n\f[R] (\f[CR]ssh \-n\f[R]).
.TP
\f[B]REMOTE_SEND\f[R]
The remote shell command used for \f[CR]zfs send\f[R].
Defaults to \f[CR]REMOTE_COMMAND\f[R] (\f[CR]ssh\f[R]).
.TP
\f[B]REMOTE_RECV\f[R]
The remote shell command used for \f[CR]zfs recv\f[R].
Defaults to \f[CR]REMOTE_DEFAULT\f[R] (\f[CR]ssh \-n\f[R]).
.SH GENERAL OPTIONS
.TP
\f[B]DEPTH\f[R]
Limit the recursion depth of operations to the number of levels
indicated.
For example, a depth of 1 will only include the indicated
\f[I]source\f[R] dataset.
Has no effect with \f[B]REPLICATE\f[R] enabled.
.TP
\f[B]EXCLUDE\f[R]
Exclude datasets or source snapshots matching the specified exclusion
pattern.
See \f[I]EXCLUSION PATTERNS\f[R] below.
.SH ZELTA MATCH OPTIONS
.TP
\f[B]SCRIPTING_MODE\f[R]
Suppress column headers and separate columns with a single tab.
Useful for parsing output in scripts.
.TP
\f[B]PARSABLE\f[R]
Output sizes in exact numbers instead of human\-readable values like
\f[CR]1M\f[R].
.TP
\f[B]PROPLIST\f[R]
Specify a list of \f[CR]zelta match\f[R] columns.
See \f[B]zelta\-match(8)\f[R] for more detail.
.TP
\f[B]LIST_WRITTEN\f[R]
Calculate data sizes for datasets and snapshots in the summary.
Enabled by default.
.TP
\f[B]CHECK_TIME\f[R]
Calculate the time of each \f[CR]zfs list\f[R] operation.
.SH ZFS SEND/RECEIVE OPTIONS
.TP
\f[B]SEND_OVERRIDE\f[R]
Override all \f[CR]zfs send\f[R] options with those indicated.
For precise and flexible configuration for different circumstances, use
the \f[CR]SEND_*\f[R] variables below instead.
.TP
\f[B]SEND_DEFAULT\f[R]
Options used for unencrypted filesystems and volumes.
Defaults to \f[CR]\-Lce\f[R].
.TP
\f[B]SEND_RAW\f[R]
Options used for encrypted datasets.
Defaults to \f[CR]\-Lw\f[R].
.TP
\f[B]SEND_NEW\f[R]
Additional option used for new datasets.
Defaults to \f[CR]\-p\f[R].
.TP
\f[B]SEND_INTR\f[R]
Toggle option to transmit intermediate snapshots (\f[CR]1\f[R], the
default) or incremental (\f[CR]0\f[R]).
.TP
\f[B]SEND_REPLICATE\f[R]
Options to use in \f[CR]zelta backup \-R\f[R] mode.
Defaults to \f[CR]zfs send \-LsRw\f[R].
.TP
\f[B]SEND_CHECK\f[R]
Attempt to drop unsupported \f[CR]zfs send\f[R] options using a no\-op
test prior to replication.
This feature is not fully implemented.
.TP
\f[B]RECV_OVERRIDE\f[R]
Override all \f[CR]zfs receive\f[R] options with those indicated.
For precise and flexible configuration, use the \f[CR]RECV_*\f[R]
variables instead.
.TP
\f[B]RECV_DEFAULT\f[R]
Default \f[CR]zfs recv\f[R] options.
Defaults to none.
.TP
\f[B]RECV_TOP\f[R]
Additional options for the top dataset during new (full) backup.
Defaults to \f[CR]\-o readonly=on\f[R].
.TP
\f[B]RECV_FS\f[R]
Additional options for filesystems during a new (full) backup.
Defaults to \f[CR]\-u \-x mountpoint \-o canmount=noauto\f[R].
.TP
\f[B]RECV_VOL\f[R]
Additional options for volumes new (full).
Defaults to none.
.TP
\f[B]RECV_PROPS_ADD\f[R]
Add the list of `zfs recv \-o' properties in the form
\f[B]property=value\f[R].
See `zfs\-receive(8)'.
.TP
\f[B]RECV_PROPS_DEL\f[R]
Add the list of `zfs recv \-x' excluded properties.
See `zfs\-receive(8)'.
.TP
\f[B]RECV_PARTIAL\f[R]
Additional options if RESUME is enabled.
Defaults to \f[CR]\-s\f[R].
.TP
\f[B]RECV_PREFIX\f[R]
Pipe output through the indicated command, such as
\f[CR]dd status=progress\f[R].
.TP
\f[B]RESUME\f[R]
Enable (\f[CR]1\f[R], the default) or disable automatic resume of
interrupted syncs.
.SH REPLICATION OPTIONS
.TP
\f[B]SNAP_NAME\f[R]
Specify a snapshot name.
Use the form \f[CR]$(my_snapshot_program)\f[R] to use a dynamically
generated snapshot.
The default is \f[CR]$(date \-u +zelta_%Y\-%m\-%d_%H.%M.%S)\f[R].
.TP
\f[B]SNAP_MODE\f[R]
Specify when to snapshot during a \f[CR]zelta backup\f[R] operation.
Options: \f[CR]0\f[R] (never), \f[CR]IF_NEEDED\f[R] (default, only if
source has new data), or \f[CR]ALWAYS\f[R].
.TP
\f[B]SYNC_DIRECTION\f[R]
If both endpoints are remote, use \f[CR]PULL\f[R] (the default) or
\f[CR]PUSH\f[R] sync.
If set to \f[CR]0\f[R], traffic will stream through the local host.
Note that this feature PUSH and PULL features require appropriate ssh
configurations with keys properly installed and/or ssh agent forwarding
enabled.
.SH CLONE OPTIONS
.TP
\f[B]CLONE_DEFAULT\f[R]
Options for recursive cloning.
Defaults to \f[CR]\-po readonly=off\f[R].
.SH POLICY OPTIONS
The following options only effect \f[CR]zelta policy\f[R] operations.
.TP
\f[B]RETRY\f[R]
Retry failed syncs the indicated number of times.
.TP
\f[B]JOBS\f[R]
Run the indicated number of policy jobs concurrently, one for each Site
in the configuration.
.TP
\f[B]BACKUP_ROOT\f[R]
The relative target path for backup jobs.
For example, \f[CR]bkhost:tank/Backups\f[R] would place backups below
that dataset (if not overridden by policy).
.TP
\f[B]ARCHIVE_ROOT\f[R]
NOT YET IMPLEMENTED.
The relative target path used for rotated clones.
.TP
\f[B]ADD_HOST_PREFIX\f[R]
Include the source hostname as a parent of the synced target.
.IP \(bu 2
Example: Source \f[CR]web1:sink/dataset\f[R] with
\f[CR]BACKUP_ROOT: tank/backups\f[R] becomes
\f[CR]tank/backups/web1/dataset\f[R].
.TP
\f[B]ADD_DATASET_PREFIX\f[R]
Similar to \f[CR]zfs recv \-d\f[R], include the indicated number of
parent dataset labels for the \f[CR]BACKUP_ROOT\f[R]\(cqs (or specified
target\(cqs) name.
If set to \f[CR]\-1\f[R] all labels up to the pool name will be attached
to the target name.
.IP \(bu 2
Example: Source \f[CR]web1:sink/source/dataset\f[R] with
\f[CR]BACKUP_ROOT: tank/backups\f[R]:
.RS 2
.IP \(bu 2
\f[CR]0\f[R]: \f[CR]tank/backups/dataset\f[R]
.IP \(bu 2
\f[CR]1\f[R]: \f[CR]tank/backups/source/dataset\f[R]
.IP \(bu 2
\f[CR]\-1\f[R]: \f[CR]tank/backups/sink/source/dataset\f[R]
.RE
.IP \(bu 2
\f[B]ADD_HOST_PREFIX\f[R] stacks with \f[B]ADD_DATASET_PREFIX\f[R].
With both enabled, the hostname is prepended first:
\f[CR]tank/backups/web1/source/dataset\f[R].
.SH EXCLUSION PATTERNS
The EXCLUDE option, or the arguments \f[B]\-\-exclude\f[R] or
\f[B]\-X\f[R], contain a comma separated list of patterns to exclude
datasets or source snapshots from operations.
Excluding a dataset will also exclude its children.
.SS Pattern Types
.TP
\f[B]Absolute Dataset Path\f[R]
Similar to \f[B]zfs send \-\-exclude\f[R], exclude the named source
dataset from operations.
.RS
Example: \f[CR]tank/vm/swap\f[R] excludes that specific dataset.
.RE
.TP
\f[B]Relative Dataset Path\f[R]
Prefix with \f[CR]/\f[R] to exclude the dataset suffix relative to the
given dataset name.
.RS
Example: Given the dataset \f[CR]sink/swap\f[R] and the pattern
\f[CR]/swap\f[R]: \f[CR]sink/swap\f[R] will be excluded, but
\f[CR]sink/vm/swap\f[R] will \f[B]not\f[R] be excluded.
.RE
.TP
\f[B]Relative Dataset Pattern\f[R]
Use glob\-like matching of \f[CR]*\f[R] (zero or more characters) or
\f[CR]?\f[R] (single character).
The pattern must start with `/' or \(cq*\(cq and must contain a `/'.
.RS
Examples, given the given \f[I]source\f[R] of \f[CR]sink/data\f[R]:
.IP \(bu 2
\f[CR]*/swap\f[R] would exclude \f[CR]sink/data/one/swap\f[R],
\f[CR]sink/data/two/swap\f[R], and \f[CR]sink/data/swap\f[R]
.IP \(bu 2
\f[CR]/*/swap\f[R] would exclude \f[CR]sink/data/one/swap\f[R] and
\f[CR]sink/data/two/swap\f[R] but \f[B]not\f[R]
\f[CR]sink/data/swap\f[R]
.IP \(bu 2
\f[CR]/vm\-*\f[R] would exclude \f[CR]sink/data/vm\-one\f[R] and its
descendants, but \f[B]not\f[R] \f[CR]sink/data/vm/one\f[R]
.IP \(bu 2
\f[CR]/test?\f[R] would exclude \f[CR]sink/data/test1\f[R] but
\f[B]not\f[R] \f[CR]sink/data/test15\f[R]
.RE
.TP
\f[B]Snapshot Name\f[R]
Match snapshots by name.
Prefix with \f[CR]\(at\f[R] to indicate a snapshot.
.RS
Example: \f[CR]\(atmanual\-backup\f[R] excludes any snapshot named
\f[CR]manual\-backup\f[R].
.RE
.TP
\f[B]Snapshot Pattern\f[R]
Use glob\-like matching of \f[CR]*\f[R] (zero or more characters) or
\f[CR]?\f[R] (single character).
Snapshot names must begin with \f[CR]\(at\f[R].
.RS
Examples:
.IP \(bu 2
\f[CR]\(at*_hourly\f[R] excludes snapshots ending in \f[CR]_hourly\f[R]
.IP \(bu 2
\f[CR]\(atsnap\-2024*\f[R] excludes snapshots beginning with
\f[CR]snap\-2024\f[R]
.IP \(bu 2
\f[CR]\(atauto\-*00??\f[R] excludes snapshots beginning with
\f[CR]auto\-\f[R] and ending with 00 and two of any character
.RE
.SS Exclusions Quick Reference
.PP
.TS
tab(@);
l l l.
T{
Pattern Type
T}@T{
Example
T}@T{
Matches
T}
_
T{
Absolute dataset
T}@T{
\f[CR]tank/vm/swap\f[R]
T}@T{
Exact dataset
T}
T{
Relative dataset
T}@T{
\f[CR]/tmp\f[R]
T}@T{
Top dataset ending in \f[CR]/tmp\f[R]
T}
T{
Relative dataset wildcard
T}@T{
\f[CR]*/swap\f[R]
T}@T{
Any dataset ending in \f[CR]/swap\f[R]
T}
T{
Snapshot name
T}@T{
\f[CR]\(atmanual\-backup\f[R]
T}@T{
Exact snapshot name
T}
T{
Snapshot wildcard
T}@T{
\f[CR]\(at*_hourly\f[R]
T}@T{
Snapshots matching pattern
T}
.TE
.SS Behavior Notes
\f[B]Datasets\f[R]
.PP
Excluding a dataset will also exclude its descendants.
.PP
\f[B]Snapshots\f[R]
.PP
For incremental replication, at least one common snapshot must remain
between source and target.
Therefore, snapshot exclusion logic is only meaningful when applied to
incremental source snapshots in incremental mode (\f[B]SEND_INTR=0\f[R]
or \f[B]\-i\f[R]).
For example, snapshot exclusion is useful for skipping hourly snapshots
and but updating dailies.
.IP \(bu 2
Excluding a target\(cqs most recent snapshot will cause an incremental
to fail
.IP \(bu 2
In intermediate mode (the default), intermediate snapshots will still be
included
.IP \(bu 2
Bookmark exclusions are not supported as they serve only as replication
sources
.SH EXAMPLES
Set options via environment for a one\-off run:
.IP
.EX
export ZELTA_LOG_LEVEL=4
export ZELTA_REMOTE_COMMAND=\(dqssh \-p 2202\(dq
zelta backup pool/dataset remote:pool/backup
.EE
.PP
Configure \f[CR]zelta.conf\f[R]:
.IP
.EX
# In zelta.conf, variables act as policy scopes but
# use the same option names.
LOG_MODE: json
JOBS: 2

NYC1:
  BACKUP_ROOT: backuphost:tank/Backups
  RETRY: 3
.EE
.SH SEE ALSO
zelta(8), zelta\-backup(8), zelta\-clone(8), zelta\-match(8),
zelta\-policy(8), zelta\-rotate(8), zelta\-sync(8), cron(8), ssh(1),
zfs(8)
.SH AUTHORS
Daniel J. Bell <\f[I]bellhyve\(atzelta.space\f[R]>
.SH WWW
https://zelta.space
