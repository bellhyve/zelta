#!/bin/sh

# zelta - Zelta shell wrapper
#
# Initialize the environment for Zelta subcommands

zelta_init() {

	ZELTA_VERSION="Zelta Replication Suite v1.1.0-alpha"

	: ${ZELTA_ETC:="/usr/local/etc/zelta"}	# Dir for the default env and policy
	: ${ZELTA_ENV:="$ZELTA_ETC/zelta.env"}	# Edit this file to change command defaults
	if [ -r $ZELTA_ENV ]; then
	       . $ZELTA_ENV
	fi
	: ${ZELTA_SHARE:="/usr/local/share/zelta"}	# Dir for helper scripts
	: ${ZELTA_CONFIG:="$ZELTA_ETC/zelta.conf"}	# YAML for "zelta policy"

	# Zelta defaults:
	: ${ZELTA_TIME_COMMAND:="time -p"}
	: ${ZELTA_SH_COMMAND_PREFIX:="{"}
	: ${ZELTA_SH_COMMAND_SUFFIX:="; }"}
	: ${ZELTA_SNAP_NAME:="date -u +%Y-%m-%d_%H.%M.%S"}

	: ${ZELTA_SEND_DEFAULT:="-Lec"}
	: ${ZELTA_SEND_RAW:="-Lw"}
	: ${ZELTA_SEND_NEW:="-p"}
	: ${ZELTA_SEND_REPLICATE:="-Rs"}
	: ${ZELTA_SEND_CHECK:="yes"}

	: ${ZELTA_RECV_DEFAULT:=""}
	: ${ZELTA_RECV_TOP:="-o readonly=on"}
	: ${ZELTA_RECV_FS:="-u -x mountpoint"}
	: ${ZELTA_RECV_VOL:=""}
	: ${ZELTA_RECV_RESUME:="-s"}
	: ${ZELTA_RESUME:="yes"}

	: ${ZELTA_CLONE_DEFAULT:="-po readonly=off"}

	: ${ZELTA_REMOTE_COMMAND:="ssh"}
	: ${ZELTA_REMOTE_DEFAULT:="${ZELTA_REMOTE_COMMAND} -n"}
	: ${ZELTA_REMOTE_SEND:="${ZELTA_REMOTE_DEFAULT}"}
	: ${ZELTA_REMOTE_RECV:="${ZELTA_REMOTE_COMMAND}"}

	: ${ZELTA_LOG_LEVEL:="2"}

	ZELTA_VERB="${zelta_verb}"

	: ${AWK:="awk"}

	export AWK
	export $(set | grep -o '^ZELTA_[A-Z_]*')
}

zelta_args() {
	if [ -n "$1" ]; then
		_opts=$($AWK -f "$ZELTA_SHARE/zelta-args.awk" -- "$@") || exit
		eval export "$_opts"
	fi
}

zelta_log() {
	: ${max_log_level:=${ZELTA_LOG_LEVEL:-2}}
	while IFS="	" read log_level log_message; do
		: ${log_level:=${log_level:-2}}
		case $log_level in
		*[!0-9]*)	log_message="$log_level	$log_message"
				log_level=2
				;;
		esac
		: ${log_message:="missing log message"}
		if [ "$log_level" -gt "$max_log_level" ] ; then
			continue
		elif [ "$log_level" -lt "0" ] ; then
			# Force log output if log_level < 1
			echo "critical: ${log_message}" >&2 
		elif [ -t 2 ] && [ "$log_level" = 2 ] ; then
			# Basic output
			echo $log_message
		else
			case "$log_level" in
			0)	log_prefix="error: " ;;
			1)	log_prefix="warning: " ;;
			2)	log_prefix="notice: " ;;
			3)	log_prefix="info: " ;;
			*)	log_prefix="debug: " ;;
			esac
			echo "${log_prefix}${log_message}" >&2 
		fi
	done
	exit
}

# Try script name or legacy symlink name as command, else he verb to the first argument.
script_name="${0##*/}"
case "$script_name" in
'zelta')
	zelta_verb="$1";
	shift;
	;;
*) 
	zelta_verb="$script_name"
	;;
esac

case "$zelta_verb" in
ipc-log)	shift;
		zelta_log "$@"
		;;
ipc-run)
		# For internal calls. Environment is pre-set.
		zelta_verb="$1"
		shift
		;;
*)
		# Standard public-facing command; load defaults.
		zelta_init "$@"
		;;
esac

# Sanitize and load arguments into variables
zelta_args "$@"

case $zelta_verb in
	# Synonyms
	zmatch)		"$AWK" -f "$ZELTA_SHARE/zelta-match.awk" -- "$@" ;;
	zp)		"$AWK" -f "$ZELTA_SHARE/zelta-policy.awk" -- "$@" ;;
	zpull)		"$AWK" -f "$ZELTA_SHARE/zelta-replicate.awk" -- "$@" ;;
	zpush)		"$AWK" -f "$ZELTA_SHARE/zelta-replicate.awk" -- "$@" ;;
	zeport)		"$AWK" -f "$ZELTA_SHARE/zelta-report.awk" -- "$@" ;;
	# "zelta replicate" variants
	backup)		"$AWK" -f "$ZELTA_SHARE/zelta-replicate.awk" -- -sI "$@" ;;
	clone)		"$AWK" -f "$ZELTA_SHARE/zelta-replicate.awk" -- --clone "$@" ;;
	sync)		$AWK -f "$ZELTA_SHARE/zelta-replicate.awk" -- -i "$@" ;;
	# Utilities
	snapshot)	echo "$@" | "$AWK" -f "$ZELTA_SHARE/zelta-snapshot.awk" ;;
	endpoint)	echo "$@" | "$AWK" -f "$ZELTA_SHARE/zelta-endpoint.awk" ;;
	time)		"$@" | bash -c "time -p cat" ;;
	# Info
	-V|--version)	echo $ZELTA_VERSION; exit ;;
	version)	echo $ZELTA_VERSION; exit ;;
	help)		. "$ZELTA_SHARE/zelta-usage.sh" "$@" ;;
	-?|usage)	"$ZELTA_SHARE/zelta-usage.sh" "$zelta_verb" "$@" ;;
	# Matching script name action
	*)	if [ -r "$ZELTA_SHARE/zelta-$zelta_verb.awk" ]; then
			$AWK -f "$ZELTA_SHARE/zelta-$zelta_verb.awk" -- "$@"
		else
			"$ZELTA_SHARE/zelta-usage.sh" usage "$zelta_verb" "$@"
		fi ;;
esac
